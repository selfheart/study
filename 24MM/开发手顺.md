<center>开发手顺</center>

## 1、网址链接

### 1.1环境搭建

http://wiki.iauto.com/wiki/Project:Teslin/环境构筑/

### 1.2 密钥相关

\\uranus.storm\iBigtom\Users\update\03_Android\04_21MM\09_密钥

\\uranus.storm\iAuto-share\User\update\24MM\02_概要设计\04_OTA安全&key更新方案

### 1.3 共享网址

\\uranus.storm\iAuto-share\24MM\93_User\Update

### 1.4 release

\\scorpio.storm\share\node37\24MM\24MM\Lexus\teslin\master



 由于24MM的release服务器，负载过高，今天开始已经同步迁移至TTRS NAS上，需要TTRS账号，目前只是建立了一个共通的账号，大家都用同一个，老的release服务器就不在使用存放release文件了，请大家内部传达下。

老服务器地址：\\scorpio.storm\share\node37\24MM\24MM
新服务器地址：\\192.168.112.26\release
账号：24mm_release_public
密码：XZ3278sz

### 1.5服务器相关

\\uranus.storm\iAuto-share\24MM\93_User\Update\01_需求\OTA4.0(20230607)\CENTERCOM[OTA4.0センターマスタ間IF仕様書]\服务器接口调试依赖.xlsx

https://gitlab.office.iauto.com/update/appstore

\\uranus.storm\iAuto-share\User\update\24MM\01_需求\703_HU通信機能仕様書\v3.00

\\uranus.storm\iAuto-share\24MM\93_User\Update\01_需求\160_リプログラム 車載機-センタ間 IF仕様書\v3.10

https://svn.ci.iauto.com/svn/smartauto/Rhine/01_开发库/21_设计/04_软件开发/02_软件架构设计/02_软件架构设计书/01_模块架构设计/GBook/丰田_24MM_SArchitectureDesign_2.18_GBookService.xlsx

【5.组件接口设计】
接口23        boolean requestSvrHttp(StTSConnectHttpRequestIn req)            
接口24        boolean requestSvrHttpCancel(StTSConnectHttpCancelIn req)            
接口25        void onReplySvrHttp(StTSConnectHttpRequestOut rep)            
接口26        void onReplySvrHttpCancel(StTSConnectHttpCancelOut rep)   



https://svn.ci.iauto.com/svn/smartauto/Rhine/01_开发库/11_需求管理/01_原始需求/00_丰田/03_共通现地Input/中心IF&Sequence资料/IF式样书/Latest/Lexus/24MM事業体共通対向センター_インターフェース仕様書(OTA)_Ver0.10J.xlsx

##### 服务器切换：

https://svn.ci.iauto.com/svn/smartauto/Rhine/01_开发库/11_需求管理/01_原始需求/00_丰田/03_共通现地Input/中心IF&Sequence资料/IF式样书/Latest/Lexus/24CY TSC Terminal Configuration Specification_Ver1.00_Appendix(URL list) .xlsx

http://iredmine/issues/84644 



[课题 #128218: 周会纪要：FOTA试做服务器功能制限列表整理展开 - Rhine_课题管理 - Redmine (iauto.com)](http://iredmine.iauto.com/issues/128218#change-815933)



//svn.ci.iauto.com/svn/smartauto/Rhine/01_开发库/11_需求管理/01_原始需求/00_丰田/03_共通现地Input/OTA4.0/



**评价：**

https://svn.ci.iauto.com/svn/smartauto/Rhine/01_开发库/11_需求管理/01_原始需求/00_丰田/03_共通现地Input/中心IF&Sequence资料/中心评价Contents使用手顺

##### QA：

https://svn.ci.iauto.com/svn/smartauto/Rhine/01_开发库/11_需求管理/02_Q&A/QA票进度统计/TMC QA管理表/FOTA/

[Q&A #113073: 515需求分析QA整理 - Rhine_Q&A管理 - Redmine (iauto.com)](http://iredmine.iauto.com/issues/113073)



### 1.6实机烧写手顺

[实机烧写手顺 | iAutoWiki.js](http://wikijs.ci.iauto.com/zh/home/iAutoDroid_platform/teslin_project/device_repro_manual)

ADB驱动安装

https://gitlab.office.iauto.com/update/toyota/teslin/wiki/-/wikis/ADB-Interface-%E6%89%BE%E4%B8%8D%E5%88%B0%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F

### 1.7 lexus app手顺

APP层拉取代码的手顺有变更，请使用下面的命令重新拉代码：
repo init -u ssh://gerrit.iauto.com:29418/manifests/rhine/app -b teslin/master -m teslin_app.xml
repo sync -c --no-tags
repo start teslin/master --all

Wiki链接：http://wikijs.ci.iauto.com/zh/home/iAutoDroid_platform/teslin_project/project_env/get_code_and_build



## 1.8 分支提交：

演示分支如下：
共仓分支：
teslin/demo/checkpoint_october

Lexus分支：
teslin/demo/checkpoint_october  提交后填写下申请http://iredmine.iauto.com/commit_management/index?project_id=rhine_release 让张敏merge
T1分支：
rhine_ac8025/demo/checkpoint_october
T2分支：
rhine_t2/demo/checkpoint_october





app的提交只提交一个分支：teslin/master(没有T1，T2的区别，只需提交一次)

aosp的提交需要提交三个分支，和之前一样。





## 1.9 USB升级残余课题管理

[课题 #162025: 【24MM】USB升级残余课题管理 - Rhine_课题管理 - Redmine (iauto.com)](http://iredmine.iauto.com/issues/162025)



## 1.10、mcu  soc release

[ReleaseCheck #166673: [OTA/USBUpgrade\][Weekly]Release发布集约-20231113[0.0.30.81]-开发 release check - Rhine_ReleaseCheck - Redmine (iauto.com)](http://iredmine.iauto.com/issues/166673)

## 1.11 mcu烧写

http://wiki.iauto.com/w/index.php?title=Project:Rhine/UpdateManual

//svn.ci.iauto.com/svn/smartauto/Rhine/01_开发库/00_Input/04_航盛/02_基线环境/release/

## 1.12 成果物文档相关

模板地址：

[Rhine - Revision 47393: /01_开发库/01_项目管理/05_质量保证/02_流程模板/工作产品&议事录&检查单模板 (iauto.com)](https://svn.ci.iauto.com/svn/smartauto/Rhine/01_开发库/01_项目管理/05_质量保证/02_流程模板/工作产品&议事录&检查单模板/)

## 2、调试手顺

### 2.1update_engine 调试手顺

![image-20230718173819192](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230718173819192.png)



1、关闭selinux(否则无法使用IBootControl接口)
    setenforce 0

2、查看update_engine log

```
su
echo 0 > /proc/sys/kernel/printk
setprop persist.log.tag.update_engine V
setprop persist.log.tag S
setprop persist.iauto.log.switch 31
logcat -G 256m && logcat -g
logcat -s update_engine &
```

3、查看UPDATE-COMPOSER log

```
su
echo 0 > /proc/sys/kernel/printk
setprop persist.log.tag.OTA-COMPOSER V
setprop persist.log.tag S
setprop persist.iauto.log.switch 31
logcat -G 256m && logcat -g
logcat -s OTA-COMPOSER &
```



su
echo 0 > /proc/sys/kernel/printk
setprop persist.log.tag.AndroidRuntime  V
setprop persist.log.tag  S
setprop persist.iauto.log.switch 31
logcat -G 256m && logcat  -g
logcat -s AndroidRuntime  &



su
echo 0 > /proc/sys/kernel/printk

setprop persist.log.tag.OTA-COMPOSER V

setprop persist.log.tag.OTA-MASTER D

setprop persist.log.tag.TLSProxy  D

setprop persist.log.tag.UPDATE_AGENT  V

setprop persist.log.tag.update_engine V

setprop persist.log.tag  S
setprop persist.iauto.log.switch 31
logcat -G 256m && logcat  -g
logcat -s OTA-MASTER  OTA-COMPOSER  UPDATE_AGENT   TLSProxy update_engine & 



#### gbook：

su
echo 0 > /proc/sys/kernel/printk

setprop persist.log.tag.OTA-COMPOSER V

setprop persist.log.tag.OTA-MASTER D

setprop persist.log.tag.TLSProxy  D

setprop persist.log.tag.telema-gbk-svc V

setprop persist.log.tag.UPDATE_AGENT  V

setprop persist.log.tag.update_engine V

setprop persist.log.tag  S
setprop persist.iauto.log.switch 31
logcat -G 256m && logcat  -g
logcat -s OTA-MASTER  OTA-COMPOSER  UPDATE_AGENT   TLSProxy update_engine telema-gbk-svc  & 



su
echo 0 > /proc/sys/kernel/printk

setprop persist.log.tag.OTA-COMPOSER V

setprop persist.log.tag.OTA-MASTER D

setprop persist.log.tag.TLSProxy  D

setprop persist.log.tag.UPDATE_AGENT  V

setprop persist.log.tag.update_engine V

setprop persist.log.tag  S
setprop persist.iauto.log.switch 31
logcat -G 256m && logcat  -g
logcat -s OTA-MASTER  OTA-COMPOSER  UPDATE_AGENT   TLSProxy update_engine   & 





su
echo 0 > /proc/sys/kernel/printk

setprop persist.log.tag.OTA-COMPOSER V

setprop persist.log.tag.OTA-MASTER D

setprop persist.log.tag.UPDATE_AGENT  V

setprop persist.log.tag.SYS_HWH_UPDATE V

setprop persist.log.tag.SYS_HWH_UCOM_UU  V

setprop persist.log.tag.IVI-HSM-PROXY-EXTEND V

setprop persist.log.tag. IVI-HSM-SVC  V

setprop persist.log.tag  S
setprop persist.iauto.log.switch 31
logcat -G 256m && logcat  -g
logcat -s OTA-MASTER  OTA-COMPOSER  UPDATE_AGENT   SYS_HWH_UPDATE    IVI-HSM-PROXY-EXTEND IVI-HSM-SVC SYS_HWH_UCOM_UU & 





logcat -s  IVI-HSM-PROXY-EXTEND IVI-HSM-SVC



111111111111111111111111111111111111111111

logcat  -s    InstallerHal & 

ps -o user,group -p 

killall logcat



setprop persist.log.tag.InstallerHal V

logcat -s   InstallerHal & 



su
echo 0 > /proc/sys/kernel/printk
setprop persist.log.tag.SYS_HWH_UPDATE V

setprop persist.log.tag.SYS_HWH_UCOM_UU V

setprop persist.log.tag  S
setprop persist.iauto.log.switch 31
logcat -G 256m && logcat  -g
logcat -s SYS_HWH_UPDATE SYS_HWH_UCOM_UU & 



logcat -s  SYS_HWH_UCOM_UU

```
logcat -s UPDATE-
```



su
echo 0 > /proc/sys/kernel/printk
setprop persist.log.tag.telema-gbk-svc V
setprop persist.log.tag  S
setprop persist.iauto.log.switch 31
logcat -G 256m && logcat  -g
logcat -s telema-gbk-svc 



su
echo 0 > /proc/sys/kernel/printk
setprop persist.log.tag.otaTestApp V
setprop persist.log.tag  S
setprop persist.iauto.log.switch 31
logcat -G 256m && logcat  -g
logcat -s otaTestApp &



wifi:

 AP-6F-03/20200804

adb push otamaster-lexus-debug.apk    /product/app/OTAMaster/OTAMaster.apk

adb push updateagent-lexus-debug.apk  /product/app/UpdateAgent/UpdateAgent.apk

adb push otacomposer-lexus-debug.apk  /product/app/OTAComposer/OTAComposer.apk

adb push hmi_info.json /update/ota_master/download/hmi_file/HMI_File.json

adb push update_info.json /update/ota_master/

adb push full_update.zip /update/ota_master/download/tus/



su
echo 0 > /proc/sys/kernel/printk
setprop persist.iauto.log.switch 31
setprop persist.iauto.appupdate true
logcat -c
logcat -G 128M
setprop persist.log.tag S
setprop persist.log.tag.UI-SYSTEMSETTING-COM V
setprop persist.log.tag S
setprop persist.log.tag.UI-SYSTEMSETTING-OTA V
setprop persist.log.tag S
setprop persist.log.tag.SystemSettingota V
setprop persist.log.tag S
setprop persist.log.tag.SystemSettingCOM V
setprop persist.log.tag S
setprop persist.log.tag.UI-SYSTEMSETTING-SYSTEMSETTING V
setprop persist.log.tag S
setprop persist.log.tag.FW_SVC_CARMODETM V
setprop persist.log.tag S
setprop persist.log.tag.MStateManager V
setprop persist.log.tag S
setprop persist.log.tag.MViewManager V
setprop persist.log.tag S
setprop persist.log.tag.SystemSettingCOM V
setprop persist.log.tag S
setprop persist.log.tag.OTA-MASTER-MODEL V
setprop persist.log.tag S
setprop persist.log.tag.OTA-MASTER V

logcat -s UI-SYSTEMSETTING-COM UI-SYSTEMSETTING-OTA SystemSettingota SystemSettingCOM UI-SYSTEMSETTING-SYSTEMSETTING SystemSettingCOM OTA-MASTER-MODEL OTA-MASTER &



am start com.iauto.ucm/.view.McuActivity



rm /update/ota_master/update_info.json

#### 命令切换进入adb

su
sh /vendor/bin/usb_func_role.sh normal
---> 切换为adb 模式
sh /vendor/bin/usb_func_role.sh adb



T2
setprop persist.sv.debug.adb_enable 1
setprop persist.sv.debug.adb_enable 0
T1
setprop sys.usb.config adb
setprop sys.usb.config mtp
L
sh /vendor/bin/usb_func_role.sh normal
sh /vendor/bin/usb_func_role.sh adb



设置时间：

adb shell date 103014462023

6、查看分区

super分区

```
lpdump /dev/block/by-name/super
```

 

全部分区

```shell
cat /proc/partitions
```

查看分区

ls /dev/block/by-name/

当前所在分区

 getprop ro.boot.slot_suffix





### 验证MD5

md5sum.exe full_update.zip

2.2 hal调试手顺

推入

adb root

adb remount

adb push manifest.xml /vendor/etc/vintf

adb push libupdateservice.so /vendor/lib64



setprop persist.log.tag D
logcat | grep -iE "OTA" &

setprop persist.log.tag D
logcat | grep -iE "UPDATE_AGENT  " &







su
echo 0 > /proc/sys/kernel/printk
setprop persist.log.tag.OTA-COMPOSER V
setprop persist.log.tag S
setprop persist.iauto.log.switch 31
logcat -G 256m && logcat -g
logcat -s OTA-COMPOSER &

su
echo 0 > /proc/sys/kernel/printk
setprop persist.log.tag.UPDATE_AGENT  V
setprop persist.log.tag  S
setprop persist.iauto.log.switch 31
logcat -G 256m && logcat  -g
logcat -s UPDATE_AGENT &



su
echo 0 > /proc/sys/kernel/printk
setprop persist.log.tag.SYS_HWH_UPDATE V
setprop persist.log.tag  S
setprop persist.iauto.log.switch 31
logcat -G 256m && logcat  -g
logcat -s SYS_HWH_UPDATE & 



cpu测试

busybox top -n 30 -d 1

### 2.3 gbook调试手顺

编译gbook提供的api 路径：package/api/GBookLibrary 
编译出来的jar包在 package/staticlibs/com/iauto/gbook/0.1/ 有个aar的压缩包，解压后就有jar包

试做服务器网址

***\*URL\****：https://test24mmcontents.g-book.com.cn/

***\*推荐浏览器\****：Google Chrome

***\*SSL证书\****：需要导入客户端SSL证书（证书通过其他途径发行）。

***\*账户信息\****：账户需要管理员从中心后端生成，并提供给测试担当者。 hubinbin   HXDkH%4D



http://24mm-ota.ci.iauto.com/#/vehicle/vehicleDetail/3?tab=3



**机器上设置cardata内容**

正常需要收到notifyHttpCommonHeaderReadyStatus这个通知后，或者主动取得已经ready的场合，再发起HTTP请求，不然一定会error

CHIPNO_INFO 和  IMEI改成和服务器自己设置的一致的

su
sqlite3 /extdata/data/datamanager/CarDataManagerKeep.db
update TBL_STRING_ITEMS set VALUE="9876543210012345678" where KEY="DM_BK_STRING_UUID";
update TBL_STRING_ITEMS set VALUE='{"DcmConnection":1,"IMEI":"202310081234567"}' where KEY="DM_BK_STRING_DCM_INFO";
.q

网页设置CHIPNO_INFO 



这一套设置好，网络连接上。ACC OFF/ON就应该ready了



 ![image-20231008180852795](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20231008180852795.png)

### 2.4 service 调试手顺

查看当前正在运行的服务列表：

adb shell dumpsys activity services

停止目标服务

adb shell am stopservice -n <service_name>

其中 `<service_name>` 是你想要停止的目标服务的完整名称。例如，如果你想要停止名为 `com.example.app/.MyService` 的服务，可以运行以下命令：

```
Copy Codeadb shell am stopservice -n com.example.app/.MyService
```



开启服务

adb shell am startservice -n <package_name>/<service_name>

### 2.5 selinux权限问题

dmesg | grep update

[ 888.685728] type=1400 audit(1698722845.088:59410): avc: denied { transfer } for comm="OTAStateMachine" scontext=u:r:platform_app:s0:c512,c768 tcontext=u:r:update_engine:s0 tclass=binder permissive=0 app=com.iauto.otacomposer

### 2.6　命令唤起ｄａｉｇ画面

am start -n com.iauto.diag/.screens.screen.MAINACTIVITY 

### 2.7 adb关闭debug功能

如果您希望通过ADB命令关闭调试功能，可以使用以下命令：

```
adb shell settings put global adb_enabled 0
```

运行此命令后，设备将禁用USB调试功能。请注意，这个命令需要在已连接到计算机的设备上执行。

要重新启用USB调试功能，可以使用以下命令：

```
adb shell settings put global adb_enabled 1
```

这将重新启用USB调试功能，并允许再次使用ADB命令进行调试操作。

请注意，某些设备或特定的ROM可能会限制对某些设置的访问权限，因此这些命令在所有设备上可能不适用。如果出现问题，请检查设备设置中的"开发者选项"并手动关闭或打开USB调试功能。

2.8 adb命令关闭logcat



### 2.9 查看cpu性能

关闭debug功能

settings put global adb_enabled 0

关闭logcat

如果系统默认打开Log，可以使用【setprop persist.log.tag S】尝试关闭android系统log

pm uninstall --user 0 com.pachira.vpa
pm uninstall --user 0 com.pachira.tts
pm uninstall --user 0 com.autoai.vr.service_vrassistant



卸载掉四维的app

pm uninstall --user 0 com.autoai.avs.account

pm uninstall --user 0 com.autoai.media.center

pm uninstall --user 0 com.autoai.android.navi





CPU的频率是变化的，8155芯片需要修改CPU的属性：
echo performance > /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor
echo performance > /sys/devices/system/cpu/cpu4/cpufreq/scaling_governor
echo performance > /sys/devices/system/cpu/cpu7/cpufreq/scaling_governor



busybox top -n 30 -d 1

/data/busybox top -n 30 -d 1

执行后，按【1】显示所有核的信息；加算所有核idle总和





mkdir /dev/cpuset/update_background
echo 0-0 > /dev/cpuset/update_background/cpus
echo 0 > /dev/cpuset/update_background/mems
看下进程信息比如16204
echo 1715>> /dev/cpuset/update_background/cgroup.procs





2.9.1 查看进程pid

要查看 updateEngine 的进程 ID（PID），你可以使用以下命令：

```
adb shell pidof update_engine
```

要查看 updateEngine 进程的优先级，你可以使用 `top` 命令。在 Android 系统中，`top` 命令可以用来监视系统进程、CPU 使用情况、内存使用情况和其他指标。

以下是查看 updateEngine 进程优先级的步骤：

```
adb shell top -n 1 | grep update_engine
```

3. 这个命令将显示 updateEngine 进程的 CPU 占用率、虚拟内存占用等信息。其中，优先级（PR）是一个数字，表示进程的调度优先级。值越低表示优先级越高。

需要注意的是，`top` 命令是一个实时监控命令，会不断输出更新的进程信息，因此你可以使用其他参数来限制输出结果。例如， `-n` 参数可以指定 top 命令输出的次数， `grep` 命令可以过滤包含指定关键字的进程信息。

另外，如果你想要查看更多关于 updateEngine 进程的详细信息，可以使用 `ps` 命令。例如：

```shell
adb shell ps -ef | grep update_engine
```

这条命令将列出所有包含 "update_engine" 关键字的进程信息，包括用户 ID、进程 ID、优先级等。

<font color='red'>查看子线程的消耗</font>

top -n 1 -H -p <pid>

top -n 15 -H -p  2015

### 2.10 截屏

要使用 Android Debug Bridge (ADB) 命令在安卓设备上进行截屏，可以按照以下步骤操作：

1. 首先，确保你已经安装了 Android SDK 并且配置了 ADB 环境变量。你可以从 Android 开发者网站下载并安装 Android SDK。

2. 连接你的安卓设备到电脑上，并确保 USB 调试模式已启用。你可能需要在设备的开发者选项中启用 USB 调试模式，这通常需要连续点击设备的版本号或构建号。

3. 打开命令提示符（Windows）或终端（Mac/Linux），然后输入以下命令来检查设备是否连接成功：
```
adb devices
```
如果设备成功连接，将显示设备的序列号。

4. 输入以下命令来进行截屏：
```
adb shell screencap -p /sdcard/screenshot.png
screencap -p /storage/screenshot.png
```
这将在设备的 `/sdcard/` 目录下创建一个名为 `screenshot.png` 的截屏文件。

5. 使用以下命令将截屏文件从设备复制到计算机上：
```
adb pull /sdcard/screenshot.png <本地保存路径>
```
将 `<本地保存路径>` 替换为你想要保存截屏文件的本地目录。

完成以上步骤后，你就能够通过 ADB 在安卓设备上进行截屏，并将截屏文件保存到计算机上。请确保正确连接设备并配置了 ADB 环境变量，以便命令能够正常执行。

### 2.11 快速编译

修改完代码后，在不提交的情况下可以自己快速编译

jenkins工程搭建完成：
http://iautoxci.ci.iauto.com/view/rhine_ac8025/job/release_fast-rhine_ac8025/
http://iautoxci.ci.iauto.com/view/rhine_t2/job/release_fast-rhine_t2/
wiki:
http://wikijs.ci.iauto.com/zh/home/iAutoDroid_platform/teslin_project/release/fast-tesl

## ３.AES KEY更新　

#### １.２４ＭＭ　Android１２　环境下支持的ｋｅｙｓｔｏｒｅ 密钥库类型

![image-20230714162036676](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230714162036676.png)

注意：不同类型的keystore 使用差别很大，存储位置存储方式都有很大差异

#### 2.密钥库选择

加载keystore时，KeyStore.getInstance("填密钥库名称");，目前实测结果

##### 1）AndroidKeyStore 密钥库

<font color='red'>支持外部导入密钥</font>但<font color='red'>keystore的存储路径不可选</font>，keyStore.setEntry(String alias, Entry entry,ProtectionParameter protParam)时已经把密钥存入系统默认路径，不再支持keystore.strore()另存路径。<font color='red'>不支持密钥导出，只能用</font>

使用aeskey加解密时不能使用手动生成的iv，加密和解密操作使用由 Android Keystore 自动生成的随机 IV。

![image-20230717164712780](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230717164712780.png)

keystore.load(InputStream stream, char[] password)时不支持设置密码

![image-20230718115418148](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230718115418148.png)

##### 2）jdk（Oracle提供的Java开发工具包）自带密钥库

jks，jceks支持外部导入密钥且存储路径可选

##### 3）BKS密钥库

支持外部导入密钥且存储路径可选。BKS（Bouncy Castle KeyStore）是一种Java密钥库格式，它在Android平台上用于存储密钥和证书。BKS密钥库通常包含对称密钥、私钥、公钥和证书等。

![image-20230717145903711](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230717145903711.png)









### 4、查看zip，bin文件



#### Info-ZIP：

https://infozip.sourceforge.net/

linux windows 默认zip都是Info-ZIP

Info-ZIP 的目的是提供免费、可移植、高质量版本的 Zip 和 UnZip 压缩器归档实用程序，几乎所有 的os都在使用，其他zip程序的源头代码也来自info-zip。

它最知名的成果是 ZIP 文件格式的实现，但也支持其他常见的压缩格式

可以看到<font color='red'>Ubuntu原装系统用的就是info-zip</font>

[Ubuntu – 在 kinetic 中的 zip 软件包详细信息](https://packages.ubuntu.com/kinetic/zip)

 ![image-20230731180818440](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230731180818440.png)

#### 24 release tool实装：

下载上面info-zip 软件包后，cd到中zip30 执行

根据您的系统，选择适当的目标系统类型之一。例如，如果您的系统使用`cc`作为首选C编译器命令，可以尝试执行以下命令：

```
bashCopy Codemake -f unix/Makefile generic
```

如果`gcc`是首选编译器，可以使用以下命令：

```
bashCopy Codemake -f unix/Makefile generic_gcc
```

生成的可执行文件zip直接拿出来就可以用

<font color='red'>或者</font>

如果使用的是Ubuntu ，系统已经安装好的话，usr/bin目录下已经放了zip 和 unzip拿出来可以直接用

 ![image-20230727094840546](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230727094840546.png)

#### 4.1 zip命令：

 ![image-20230727095520504](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230727095520504.png)

##### 4.1.1 查看zip文件

unzip -Z -v  full_update.zip

 ![image-20230726212320650](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230726212320650.png)

​	每个entry的偏移量等于 offset of local header from start of archive +  中间说明信息的固定长度30 + length of filename +   length of extra field +  length of file comment

##### 4.1.2 无压缩存储

zip -0 full_update.zip git-mysql-master (数字0不是字母o)

### 4.2 xxd命令

 ![image-20230731140735336](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230731140735336.png)

#### 4.2.1 查看指定位置开始256byte

xxd -s 1027492116 -l 256 full_update.zip



### 5.升级的分区

\\uranus.storm\iAuto-share\User\update\24MM\02_概要设计\08_升级对象

 ![image-20230728135808531](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230728135808531.png)





T1

boot_a
vbmeta_a
vbmeta_system_a
vendor_boot_a                                    
dtbo_a
vbmeta_vendor_a                       
datazone-ro_a                  
hsm_a
dtb_a
recovery_a
datazone-rw-a               
preloader_a
lk_a
trustzone_a     



T2





### 6.docker

sudo docker run -it --tmpfs /tmp:exec --entrypoint /bin/bash --rm -w $HOME -v $HOME:$HOME -e HOME=$HOME -v /etc/passwd:/etc/passwd -v /etc/group:/etc/group --device /dev/kvm -e DISPLAY=${DISPLAY} -e USER=$(whoami) -v /tmp/.X11-unix:/tmp/.X11-unix -u $(id -u ${USER}):$(id -g ${USER}) --dns=192.168.2.14 --device /dev/fuse --ulimit nofile=40960 --privileged iregistry.iauto.com/ci_members/iautoandroid-container/common/fullenv:feature-android12

1. 在什么身份下进入docker，在docker就是什么身份

-v 用来挂载分区

2.添加配置当前用户为root用户身份进行

对于当前用户以 root 用户身份运行容器，可以将 `-u $(id -u ${USER}):$(id -g ${USER})` 修改为 `-u 0`





### 7、开发机bulid相关

7.1 build出问题，repo sync之后还是报错，可能是某些大文件未被更新运行下面这条命令

- ```
  repo forall -c 'git-lfs pull'
  ```

  `epo forall` 表示针对所有仓库执行后续的命令。`-c 'git-lfs pull'` 是要执行的命令，即在每个仓库中运行 `git-lfs pull`。

  `git-lfs` 是 Git Large File Storage 的缩写，它是一个用于处理大文件的插件。`git-lfs pull` 是用于从远程服务器下载 LFS（Large File Storage）对象和数据的命令。当你在仓库中使用了 LFS 并希望获取最新的 LFS 文件时，可以运行这个命令。

  因此，`repo forall -c 'git-lfs pull'` 将在所有仓库中执行 `git-lfs pull` 命令，以确保获取最新的 LFS 文件。请确保已经正确安装并配置了 Git LFS 插件，否则命令可能无法正常执行

  



### 8、openssl 

8.1、EC证书相关

ECDSA（Elliptic Curve Digital Signature Algorithm）中生成的签名大小是可变的，并且通常取决于所使用的椭圆曲线的参数和哈希算法的输出长度，以及签名工具。椭圆曲线的参数由输入的EC证书决定，不能改变了。

<font color='red'>21用的是如下命令，openssl 先计算哈希，后用host/linux-x86/bin/singer签名，生成的签名大小是64byte</font>，这种方式生成的签名，我在Java jdk自带算法是验证不过的，openssl命令也验证不过。

```
 openssl dgst -sha256 -binary -out $DEPATH/extra_info.sha256 $1
 $PWDPATH/../host/linux-x86/bin/singer sign $PWDPATH/../config/testkey.pem $DEPATH/extra_info.sha256 $DEPATH/extra_info.sig

```

24使用以下命令，根据 OpenSSL 的默认行为，在使用 P-256 椭圆曲线和 SHA-256 哈希算法的情况下，ECDSA 签名大小通常为<font color='red'>70至72字节</font>。

注意：24目前用的openssl版本是   OpenSSL 1.1.1  11 Sep 2018 <font color='red'>对应的签名大小是72</font>

```
openssl dgst -sha256 -sign $PWDPATH/../config/testkey.pem -out $DEPATH/extra_info.sig $1
```

总之，二者使用的都是ECDSAwithSHA256,即P-256 椭圆曲线和 SHA-256 哈希算法，只是签名大小不同。

<font color='red'>坑：</font>签名大小不对，导致读了错误签名

```
 UPDATE_AGENT: AESCBC128Crypto.decrypted(Line:101)decrypted error : javax.crypto.IllegalBlockSizeException: error:1e00007b:Cipher functions:OPENSSL_internal:WRONG_FINAL_BLOCK_LENGTH
```

查看EC证书

 ![image-20230911115425620](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230911115425620.png)

这段输出是使用 OpenSSL 读取 EC 密钥后生成的，其中包括了私钥、公钥和椭圆曲线的相关信息。具体解释如下：

- Private-Key: (256 bit): 私钥长度为 256 bit。
- priv: 私钥的十六进制字符串表示。
- pub: 公钥的十六进制字符串表示。
- ASN1 OID: prime256v1：指定了使用的椭圆曲线曲线名称，在这里是 prime256v1，也就是 P-256。
- NIST CURVE: P-256：与 ASN1 OID 中指定的椭圆曲线名称对应。







例如，在使用 P-256 椭圆曲线和 SHA-256 哈希算法的情况下，ECDSA 签名通常是一个由两个整数 r 和 s 组成的 DER 编码的字节序列。在这种情况下，签名的大小通常约为 70-72 字节。





### 9、bsp编译问题

http://wiki.iauto.com/wiki/Project:Teslin/环境构筑/

担当：张保伟

<font color='red'>bsp要在docker做，并且要用aosp中的qcom_meta,不能移出来</font>

1、bsptoolchain 未放到meta下，导致执行这一步mkdir -p /pkg/qct
ln -s $meta_root_dir/bsp_toolchain /pkg/qct/software已经失败，HEXAGON工具找不到

```
** INFO: TMS TMS_MAX_THREADS configured value 160
!! ERROR: 
!! ERROR: -------------------------------------------------------------------------------
!! ERROR: *** HEXAGON tools are not present
!! ERROR: *** Please install HEXAGON tools RTOS 1.1, 2.0Beta, etc.
!! ERROR: *** Currently setup for RTOS: 8.2.05
!! ERROR: *** Missing RTOS PATH: /home/develop/workspace/24MMBsp/meta/adsp_8155/adsp_proc/build/bsp/adsp_link/build/None/8.2.05
!! ERROR: -------------------------------------------------------------------------------
!! ERROR
```

### 10、aosp代码编译

前提：新开发机用的ci镜像

teslin.xml 现在是二进制的环境，teslin_build.xml 这个xml是源码

拉取代码：

```
dev-docker中选择iautoandroid 
 repo init -u ssh://gerrit.iauto.com:29418/manifests/qualcomm_8155/android12/teslin -b teslin/master -m teslin_build.xml
 repo sync -c --no-tags
 repo start teslin/master --all
```

遇到问题后

  \#repo forall -c git clean -fdx
  \#repo forall -c git reset --hard HEAD
在代码更目录执行上面两句，把本地的可能的修改都回退掉，然后在repo sync

编译有问题时：

拉一下大文件

```
repo forall -c 'git-lfs pull'
```



1、docker中ccache的路径指示错误了，怎么改回来

/bin/sh: 1: /usr/bin/ccache: not found 12:10:42 ninja failed with: exit status 1 #### failed to build some targets (01:12 (mm:ss)) #### #### hidl-gen compilation failed, check above errors #### root@ab30ee4f03b3:~/ssd/workspace/24MM# which ccache /usr/local/bin/ccache

如果在 Docker 中安装 ccache 后出现了路径指示错误，你可以尝试以下步骤来进行修复：

1. 进入 Docker 容器：
   ```bash
   docker exec -it <container_id> /bin/bash
   ```
   其中 `<container_id>` 是你要进入的容器的 ID 或名称。

2. 编辑环境变量配置文件（例如 ~/.bashrc 或 /etc/profile）并将 ccache 的路径修改为正确的值。你可以使用任何文本编辑器打开文件进行编辑，例如使用 vi 编辑器：
   ```bash
   vi ~/.bashrc
   ```
   或者使用 nano 编辑器：
   ```bash
   nano ~/.bashrc
   ```

3. 在文件中找到包含 ccacche 路径的行，并将其更正为正确的路径。例如，将路径更改为 `/usr/local/ccache`：
   ```bash
   export PATH="/usr/local/ccache:$PATH"
   ```

4. 保存文件并退出编辑器，然后重新加载环境变量配置文件：
   ```bash
   source ~/.bashrc
   ```

5. 最后，退出 Docker 容器：
   ```bash
   exit
   ```

完成上述步骤后，你应该已经成功将 ccache 的路径指示错误修复回来。请确保将正确的路径设置为 ccacche 的路径，并根据你的实际情况进行相应的修改。









`repo sync --force-sync` 

是用于强制同步代码仓库的命令。

使用 `repo sync` 命令可以将本地工作目录与远程代码仓库同步，在执行同步操作之前，`--force-sync` 参数会强制清除本地所有修改和提交，以确保本地代码与远程仓库完全一致。



**编译不过，报莫名其妙的错误，make clean 后重启，再试**,有可能虚拟机内存不够 

### 11、实机烧写

[实机烧写手顺 | iAutoWiki.js](http://wikijs.ci.iauto.com/zh/home/iAutoDroid_platform/teslin_project/device_repro_manual)





### 12、SettingsProvider

Settings分为三类，分别存储在不同的xml文件中：
settings_system.xml	包含各种各样的用户偏好系统设置
settings_global.xml	所有的偏好设置对系统的所有用户公开，第三方APP有读没有写的权限
settings_secure.xml	安全性的用户偏好系统设置，第三方APP有读没有写的权限

列出所有的属性：

    adb shell settings list system
    adb shell settings list global
    adb shell settings list secure

使用ADB获取与修改属性：

    # get方法
    adb shell settings get system font_scale
    # set方法
    adb shell settings put system font_scale 1.6
settings put global debug.ota.switch  off

settings get global debug.ota.switch

settings delete global debug.ota.switch



settings put global debug.ota.url http://192.168.248.7:32677

settings get global debug.ota.url

settings delete global debug.ota.url





#### 如果你需要禁用或启用防火墙，请尝试使用以下命令：

1. 启用防火墙：

```
adb shell su 0 iptables -I INPUT -j ACCEPT
```

禁用防火墙：

```

adb shell su 0 iptables -F
```

# TODO:



1.full_update.zip做包和解析



2.bigdata 密钥更新

 ![image-20230728112006428](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230728112006428.png)

3.bsp手顺 做出来的release缺少 system，vendor，system_ext

<font color='red'>已解决：</font>

放在：![image-20230801143623580](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230801143623580.png)

 ![image-20230801143515804](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230801143515804.png)



4、toyota update_engine 代码改成和lexus一样套路（加解密）

http://wiki.iauto.com/wiki/Project:Rhine/%E7%8E%AF%E5%A2%83%E6%9E%84%E7%AD%91/%E4%BB%A3%E7%A0%81%E4%B8%8B%E8%BD%BD%26%E7%BC%96%E8%AF%91

 repo init -u ssh://gerrit.iauto.com:29418/manifests/rhine/ac8025 -b rhine_ac8025/master -m default.xml
 repo sync -c --no-tags
 repo start rhine_ac8025/master --all

目前最新的AC8025的分支和仓库



5、屏蔽soc激活接口







7、https通信，文件下载有没有更好的断点续传方案

目前是记录readLength，频繁io操作

```
public void progress(long read, long contentLength, final boolean done){
    //更新已下载的文件大小
    if (info.getContentLength() > contentLength) {
        read = read + (info.getContentLength() - contentLength);
    } else {
        info.setContentLength(contentLength);
    }
    info.setReadLength(read);
    //切换到主线程
    Disposable d = Observable.just(1)
            .subscribe(new Consumer<Integer>() {
                @Override
                public void accept(Integer integer) {
                    if (done) {
                        listener.onFinishDownload(info.getSavePath() + File.separator + info.getFileName(), info.getState());
                        info.setState(DownState.FINISH);
                    } else {
                        if(info.getState() == DownState.DOWNLOADING) {
                            if (info.getContentLength() > 0) {
                                listener.onProgress(info.getReadLength(), info.getContentLength(), info.getState());
                            } else {
                                // 获取不到文件总大小(contentLength==0)
                                listener.onProgress(info.getReadLength(), -1, info.getState());
                            }
                        }
                    }
                }
            });
}
```

```
public void setReadLength(long readLength) {
    this.readLength = readLength;
    writeToJsonFIle();//便于断电续传，断电再启动时，从断点处恢复下载
}
```

8、每次验签要验证两次,间隔一个1秒内的随机时间

![image-20230810205532821](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230810205532821.png)

 ![image-20230810205603604](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230810205603604.png)

<font color='red'>电源攻击</font>是指攻击者试图通过干扰或控制系统的电源来获取未经授权的访问或破坏系统的机密性、完整性或可用性。例如，攻击者可能会试图关闭系统电源，引发电压波动，或者提供不稳定的电源供应，以使系统无法正常运行或暴露安全漏洞。

<font color='red'>时钟故障攻击</font>是指攻击者试图通过干扰系统的时钟信号或时钟源，来破坏或绕过安全控制措施。攻击者可能会改变时钟频率、引入时钟延迟或噪声，或者以其他方式干扰时钟信号的正确运行。这些干扰可以导致系统在执行关键操作时产生错误，从而绕过验证过程或破坏安全机制。

为了防范电源攻击和时钟故障攻击，需要采取适当的安全措施，包括设计电源和时钟系统的鲁棒性、使用物理层面的保护措施（如电路隔离）、实施检测和响应机制等。此外，<font color='red'>软件层面的缓解措施，如非确定性时间间隔的重复检查</font>，也可以增加系统的安全性和抵御攻击的能力。



9、update.zip的解析移到package com.iauto.updateagent



10、updateEngine的modelID逻辑没完全组装

- [x] 11、update engine 更改出问题查找  #if  0                  over

12、updateEngine 详细设计重写，只写修改的部分，之前里面写的是composer调用updateEngine的部分放在composer中

13、updateEngine代码 TODO时间戳更改，研究一下，21未更改

14、做包的password随机生成

15、原生updateEngine会自动切面，不让自动切面要屏蔽掉setactivity

- [x] 16、aosp代码更改要申请票http://iredmine.iauto.com/issues/81120 

<font color='red'>已申请</font>

17、payload_consumer/delta_perform.cc 新家内部类，确认必要性。

18、

集成测试:做一个SOC全量包，SOC+firmwares全量包的case 文档要补

[工作产品 #103486: USB更新_[UpdateEngine\]全量包更新_软件集成测试 - Rhine_Update - Redmine (iauto.com)](http://iredmine.iauto.com/issues/103486)

19、

C:\Users\jiangzhuangzhuang\study\study\24MM\TLS\CENTERCOM[OTA4.0センターマスタ間IF仕様書]

这个文档中UI的URL也要取出来帮UI去get下载

![image-20230906211012911](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230906211012911.png)

21、此消息没有对应request，已经QA

![image-20230906213118602](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230906213118602.png)

22、单体测试工程参考其他人放到开发网上

23、做包时是否需要加密，要用一个flag判断，看一下能否和安卓原生做包用同一个flag

24、/data/user_de/0/com.iauto.updateagent/files 这里面的user_de可能会改变，不能写死

25、java版权和注释统一

26、update_engine详设 对外提供接口改一下,有接口的，对composer提供的接口



27、 

![image-20231009112341603](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20231009112341603.png)

28、做包只做soc，升级解析出现问题。必须包含FIRMware，需调查。

29、OTAMaster架构设计添加Gbook ，cardata 、消息中心外部接口

30、做包Firmwares里面结构改变会导致，解密的时候解析出现问题，需调查一下。



31、updateEngine 权限配置 李楠

10-20 07:38:58.179 1712 1712 W update_engine: type=1400 audit(0.0:66687): avc: denied { search } for name="/" dev="sda19" ino=2 scontext=u:r:update_engine:s0 tcontext=u:object_r:iauto_update_file:s0 tclass=dir permissive=0



32、下载log设置成v，防止刷屏

33、下载完成 通知master测试

34、校验失败，安装失败，补一下代码