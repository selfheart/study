<center>开发手顺</center>

## 1、网址链接

### 1.1环境搭建

http://wiki.iauto.com/wiki/Project:Teslin/环境构筑/

1.2 密钥相关

\\uranus.storm\iBigtom\Users\update\03_Android\04_21MM\09_密钥

\\uranus.storm\iAuto-share\User\update\24MM\02_概要设计\04_OTA安全&key更新方案

1.3 共享网址

\\uranus.storm\iAuto-share\24MM\93_User\Update

1.4 release

\\scorpio.storm\share\node37\24MM\24MM\Lexus\teslin\master

1.5服务器相关

\\uranus.storm\iAuto-share\24MM\93_User\Update\01_需求\OTA4.0(20230607)\CENTERCOM[OTA4.0センターマスタ間IF仕様書]\服务器接口调试依赖.xlsx



### 2、update_engine 调试手顺

![image-20230718173819192](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230718173819192.png)



1、关闭selinux(否则无法使用IBootControl接口)
    setenforce 0

2、查看update_engine log

```
su
echo 0 > /proc/sys/kernel/printk
setprop persist.log.tag.update_engine V
setprop persist.log.tag S
setprop persist.iauto.log.switch 31
logcat -G 256m && logcat -g
logcat -s update_engine &
```

3、查看UPDATE-COMPOSER log

```
su
echo 0 > /proc/sys/kernel/printk
setprop persist.log.tag.UPDATE-COMPOSER V
setprop persist.log.tag S
setprop persist.iauto.log.switch 31
logcat -G 256m && logcat -g
logcat -s UPDATE-COMPOSER &
```

4、



6、查看分区

super分区

```
lpdump /dev/block/by-name/super
```

 

全部分区

```shell
cat /proc/partitions
```



当前所在分区

 getprop ro.boot.slot_suffix





### ３.AES KEY更新　

#### １.２４ＭＭ　Android１２　环境下支持的ｋｅｙｓｔｏｒｅ 密钥库类型

![image-20230714162036676](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230714162036676.png)

注意：不同类型的keystore 使用差别很大，存储位置存储方式都有很大差异

#### 2.密钥库选择

加载keystore时，KeyStore.getInstance("填密钥库名称");，目前实测结果

##### 1）AndroidKeyStore 密钥库

<font color='red'>支持外部导入密钥</font>但<font color='red'>keystore的存储路径不可选</font>，keyStore.setEntry(String alias, Entry entry,ProtectionParameter protParam)时已经把密钥存入系统默认路径，不再支持keystore.strore()另存路径。<font color='red'>不支持密钥导出，只能用</font>

使用aeskey加解密时不能使用手动生成的iv，加密和解密操作使用由 Android Keystore 自动生成的随机 IV。

![image-20230717164712780](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230717164712780.png)

keystore.load(InputStream stream, char[] password)时不支持设置密码

![image-20230718115418148](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230718115418148.png)

##### 2）jdk（Oracle提供的Java开发工具包）自带密钥库

jks，jceks支持外部导入密钥且存储路径可选

##### 3）BKS密钥库

支持外部导入密钥且存储路径可选。BKS（Bouncy Castle KeyStore）是一种Java密钥库格式，它在Android平台上用于存储密钥和证书。BKS密钥库通常包含对称密钥、私钥、公钥和证书等。

![image-20230717145903711](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230717145903711.png)









### 4、查看zip，bin文件



#### Info-ZIP：

https://infozip.sourceforge.net/

linux windows 默认zip都是Info-ZIP

Info-ZIP 的目的是提供免费、可移植、高质量版本的 Zip 和 UnZip 压缩器归档实用程序，几乎所有 的os都在使用，其他zip程序的源头代码也来自info-zip。

它最知名的成果是 ZIP 文件格式的实现，但也支持其他常见的压缩格式

可以看到<font color='red'>Ubuntu原装系统用的就是info-zip</font>

[Ubuntu – 在 kinetic 中的 zip 软件包详细信息](https://packages.ubuntu.com/kinetic/zip)

 ![image-20230731180818440](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230731180818440.png)

#### 24 release tool实装：

下载上面info-zip 软件包后，cd到中zip30 执行

根据您的系统，选择适当的目标系统类型之一。例如，如果您的系统使用`cc`作为首选C编译器命令，可以尝试执行以下命令：

```
bashCopy Codemake -f unix/Makefile generic
```

如果`gcc`是首选编译器，可以使用以下命令：

```
bashCopy Codemake -f unix/Makefile generic_gcc
```

生成的可执行文件zip直接拿出来就可以用

<font color='red'>或者</font>

如果使用的是Ubuntu ，系统已经安装好的话，usr/bin目录下已经放了zip 和 unzip拿出来可以直接用

 ![image-20230727094840546](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230727094840546.png)

#### 4.1 zip命令：

 ![image-20230727095520504](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230727095520504.png)

##### 4.1.1 查看zip文件

unzip -Z -v  full_update.zip

 ![image-20230726212320650](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230726212320650.png)

​	每个entry的偏移量等于 offset of local header from start of archive +  中间说明信息的固定长度30 + length of filename +   length of extra field +  length of file comment

##### 4.1.2 无压缩存储

zip -0 full_update.zip git-mysql-master (数字0不是字母o)

### 4.2 xxd命令

 ![image-20230731140735336](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230731140735336.png)

#### 4.2.1 查看指定位置开始256byte

xxd -s 1027492116 -l 256 full_update.zip



### 5.升级的分区

\\uranus.storm\iAuto-share\User\update\24MM\02_概要设计\08_升级对象

 ![image-20230728135808531](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230728135808531.png)









































# TODO:



1.full_update.zip做包和解析



2.bigdata 密钥更新

 ![image-20230728112006428](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230728112006428.png)

3.bsp手顺 做出来的release缺少 system，vendor，system_ext

<font color='red'>已解决：</font>

放在：![image-20230801143623580](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230801143623580.png)

 ![image-20230801143515804](C:\Users\jiangzhuangzhuang\study\study\24MM\开发手顺.assets\image-20230801143515804.png)



4、toyota update_engine 代码改成和lexus一样套路（加解密）

http://wiki.iauto.com/wiki/Project:Rhine/%E7%8E%AF%E5%A2%83%E6%9E%84%E7%AD%91/%E4%BB%A3%E7%A0%81%E4%B8%8B%E8%BD%BD%26%E7%BC%96%E8%AF%91

 repo init -u ssh://gerrit.iauto.com:29418/manifests/rhine/ac8025 -b rhine_ac8025/master -m default.xml
 repo sync -c --no-tags
 repo start rhine_ac8025/master --all

目前最新的AC8025的分支和仓库



5、屏蔽soc激活接口







7、https通信，文件下载有没有更好的断点续传方案

目前是记录readLength，频繁io操作

```
public void progress(long read, long contentLength, final boolean done){
    //更新已下载的文件大小
    if (info.getContentLength() > contentLength) {
        read = read + (info.getContentLength() - contentLength);
    } else {
        info.setContentLength(contentLength);
    }
    info.setReadLength(read);
    //切换到主线程
    Disposable d = Observable.just(1)
            .subscribe(new Consumer<Integer>() {
                @Override
                public void accept(Integer integer) {
                    if (done) {
                        listener.onFinishDownload(info.getSavePath() + File.separator + info.getFileName(), info.getState());
                        info.setState(DownState.FINISH);
                    } else {
                        if(info.getState() == DownState.DOWNLOADING) {
                            if (info.getContentLength() > 0) {
                                listener.onProgress(info.getReadLength(), info.getContentLength(), info.getState());
                            } else {
                                // 获取不到文件总大小(contentLength==0)
                                listener.onProgress(info.getReadLength(), -1, info.getState());
                            }
                        }
                    }
                }
            });
}
```

```
public void setReadLength(long readLength) {
    this.readLength = readLength;
    writeToJsonFIle();//便于断电续传，断电再启动时，从断点处恢复下载
}
```